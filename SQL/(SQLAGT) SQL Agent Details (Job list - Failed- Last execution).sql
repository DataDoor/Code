/*SQLAGENT - These SQL Scripts show various details about the SQL Agent jobs


Scripts included: -

All SQL Agent jobs Details
SQL Agent Job Failures
SQL Agent last execution details
*/

/*All SQL Agent jobs Details*/

SELECT
    [sJOB].[job_id] AS [JobID]
    , [sJOB].[name] AS [JobName]
    , [sJSTP].[step_uid] AS [StepID]
    , [sJSTP].[step_id] AS [StepNo]
    , [sJSTP].[step_name] AS [StepName]
    , CASE [sJSTP].[subsystem]
        WHEN 'ActiveScripting' THEN 'ActiveX Script'
        WHEN 'CmdExec' THEN 'Operating system (CmdExec)'
        WHEN 'PowerShell' THEN 'PowerShell'
        WHEN 'Distribution' THEN 'Replication Distributor'
        WHEN 'Merge' THEN 'Replication Merge'
        WHEN 'QueueReader' THEN 'Replication Queue Reader'
        WHEN 'Snapshot' THEN 'Replication Snapshot'
        WHEN 'LogReader' THEN 'Replication Transaction-Log Reader'
        WHEN 'ANALYSISCOMMAND' THEN 'SQL Server Analysis Services Command'
        WHEN 'ANALYSISQUERY' THEN 'SQL Server Analysis Services Query'
        WHEN 'SSIS' THEN 'SQL Server Integration Services Package'
        WHEN 'TSQL' THEN 'Transact-SQL script (T-SQL)'
        ELSE sJSTP.subsystem
      END AS [StepType]
    , [sPROX].[name] AS [RunAs]
    , [sJSTP].[database_name] AS [Database]
    ,IIF([sJSTP].[subsystem] = 'SSIS',REVERSE(SUBSTRING(SUBSTRING(REVERSE([sJSTP].[command]),CHARINDEX('xstd.',REVERSE([sJSTP].[command])),LEN(REVERSE([sJSTP].[command]))),0,PATINDEX('%\%',SUBSTRING(REVERSE([sJSTP].[command]),CHARINDEX('xstd.',REVERSE([sJSTP].[command])),LEN(REVERSE([sJSTP].[command])))))),[sJSTP].[command])  AS [ExecutableCommand]
    , CASE [sJSTP].[on_success_action]
        WHEN 1 THEN 'Quit the job reporting success'
        WHEN 2 THEN 'Quit the job reporting failure'
        WHEN 3 THEN 'Go to the next step'
        WHEN 4 THEN 'Go to Step: ' 
                    + QUOTENAME(CAST([sJSTP].[on_success_step_id] AS VARCHAR(3))) 
                    + ' ' 
                    + [sOSSTP].[step_name]
      END AS [OnSuccessAction]
    , [sJSTP].[retry_attempts] AS [RetryAttempts]
    , [sJSTP].[retry_interval] AS [RetryInterval (Minutes)]
    , CASE [sJSTP].[on_fail_action]
        WHEN 1 THEN 'Quit the job reporting success'
        WHEN 2 THEN 'Quit the job reporting failure'
        WHEN 3 THEN 'Go to the next step'
        WHEN 4 THEN 'Go to Step: ' 
                    + QUOTENAME(CAST([sJSTP].[on_fail_step_id] AS VARCHAR(3))) 
                    + ' ' 
                    + [sOFSTP].[step_name]
      END AS [OnFailureAction]
FROM
    [msdb].[dbo].[sysjobsteps] AS [sJSTP]
    INNER JOIN [msdb].[dbo].[sysjobs] AS [sJOB]
        ON [sJSTP].[job_id] = [sJOB].[job_id]
    LEFT JOIN [msdb].[dbo].[sysjobsteps] AS [sOSSTP]
        ON [sJSTP].[job_id] = [sOSSTP].[job_id]
        AND [sJSTP].[on_success_step_id] = [sOSSTP].[step_id]
    LEFT JOIN [msdb].[dbo].[sysjobsteps] AS [sOFSTP]
        ON [sJSTP].[job_id] = [sOFSTP].[job_id]
        AND [sJSTP].[on_fail_step_id] = [sOFSTP].[step_id]
    LEFT JOIN [msdb].[dbo].[sysproxies] AS [sPROX]
        ON [sJSTP].[proxy_id] = [sPROX].[proxy_id]
ORDER BY [JobName], [StepNo]


/*SQL Agent Job Failures*/

WITH [SQLAgentJobsFailures]
AS(
SELECT 
    @@SERVERNAME [SQLInstance]
    ,[sJOB].[name] AS [JobName]
    , CASE 
        WHEN [sJOBH].[run_date] IS NULL OR [sJOBH].[run_time] IS NULL THEN NULL
        ELSE CAST(
                CAST([sJOBH].[run_date] AS CHAR(8))
                + ' ' 
                + STUFF(
                    STUFF(RIGHT('000000' + CAST([sJOBH].[run_time] AS VARCHAR(6)),  6)
                        , 3, 0, ':')
                    , 6, 0, ':')
                AS DATETIME)
      END AS [LastRunDateTime]
    , CASE [sJOBH].[run_status]
        WHEN 0 THEN 'Failed'
        WHEN 1 THEN 'Succeeded'
        WHEN 2 THEN 'Retry'
        WHEN 3 THEN 'Canceled'
        WHEN 4 THEN 'Running' -- In Progress
      END AS [LastRunStatus]
    , STUFF(
            STUFF(RIGHT('000000' + CAST([sJOBH].[run_duration] AS VARCHAR(6)),  6)
                , 3, 0, ':')
            , 6, 0, ':') 
        AS [LastRunDuration (HH:MM:SS)]
    , [sJOBH].[message] AS [LastRunStatusMessage]
    , CASE [sJOBSCH].[NextRunDate]
        WHEN 0 THEN NULL
        ELSE CAST(
                CAST([sJOBSCH].[NextRunDate] AS CHAR(8))
                + ' ' 
                + STUFF(
                    STUFF(RIGHT('000000' + CAST([sJOBSCH].[NextRunTime] AS VARCHAR(6)),  6)
                        , 3, 0, ':')
                    , 6, 0, ':')
                AS DATETIME)
      END AS [NextRunDateTime]
	 ,sJOB.enabled
	 ,CASE WHEN [sJOBSCH].[job_id] IS NOT NULL THEN 1 ELSE 0 END [Scheduled]
FROM 
    [msdb].[dbo].[sysjobs] AS [sJOB]
    LEFT JOIN (
                SELECT
                    [job_id]
                    , MIN([next_run_date]) AS [NextRunDate]
                    , MIN([next_run_time]) AS [NextRunTime]
                FROM [msdb].[dbo].[sysjobschedules]
                GROUP BY [job_id]
            ) AS [sJOBSCH]
        ON [sJOB].[job_id] = [sJOBSCH].[job_id]
    LEFT JOIN (
                SELECT 
                    [job_id]
                    , [run_date]
                    , [run_time]
                    , [run_status]
                    , [run_duration]
                    , [message]
                    , ROW_NUMBER() OVER (
                                            PARTITION BY [job_id] 
                                            ORDER BY [run_date] DESC, [run_time] DESC
                      ) AS RowNumber
                FROM [msdb].[dbo].[sysjobhistory]
                WHERE [step_id] = 0
            ) AS [sJOBH]
        ON [sJOB].[job_id] = [sJOBH].[job_id]
        AND [sJOBH].[RowNumber] = 1
)
SELECT *
FROM [SQLAgentJobsFailures] sjf
WHERE (Scheduled = 1 AND [Enabled] = 1) AND DATEDIFF(hh,LastRunDateTime,GETDATE()) < 24


/*SQL Agent last execution details*/

SELECT 
    Job_Name, 
    run_datetime, 
    run_duration
FROM
(
    SELECT job_name, run_datetime,
        SUBSTRING(run_duration, 1, 2) + ':' + SUBSTRING(run_duration, 3, 2) + ':' +
        SUBSTRING(run_duration, 5, 2) AS run_duration
    FROM
    (
        SELECT DISTINCT
            j.name AS job_name, 
            run_datetime = CONVERT(DATETIME, RTRIM(run_date)) +  
                (run_time * 9 + run_time % 10000 * 6 + run_time % 100 * 10) / 216e4,
            run_duration = RIGHT('000000' + CONVERT(VARCHAR(6), run_duration), 6)
        FROM msdb..sysjobhistory h
        INNER JOIN msdb..sysjobs j
        ON h.job_id = j.job_id
    ) T
) T
ORDER BY job_name, run_datetime
      

/*THIS SQL WILL ALLOW MASS CHANGES TO BACKUP SETTING FOR OLE HALLENGREN

By uncommenting the appropriate setting you want to alter will allow you to mass update this setting without
having to enter every SQL Agent backup job

Setting which can be changed are 

Backup Directory
Verify
*/




/*DECLARE & SET VARIABLES*/

/*Backup*/
DECLARE @CurrentBkpLocation NVARCHAR(100)
DECLARE @NewBkpLocation NVARCHAR(100)

SET @CurrentBkpLocation = '@Directory = N''\\EM-APPL018\ITsql'
SET @NewBkpLocation = '@Directory = N''\\SQL-BACKUPS\SQL1'

/*Verify*/
DECLARE @CurrentVerifySetting NCHAR(13)
DECLARE @NewVerifySetting NCHAR(13)

SET @CurrentVerifySetting = '@Verify = ''Y'''
SET @NewVerifySetting = '@Verify = ''N'''


/*CHECK*/
SELECT 
	[sJSTP].[command]  AS [OldLocationCommand]
	,REPLACE([sJSTP].[command],@CurrentBkpLocation,@NewBkpLocation) AS [NewBackupLocationCommand]
	,REPLACE([sJSTP].[command],@CurrentVerifySetting,@NewVerifySetting) AS [NewVerifySettingCommand]
FROM
    [msdb].[dbo].[sysjobsteps] AS [sJSTP]
    INNER JOIN [msdb].[dbo].[sysjobs] AS [sJOB]
        ON [sJSTP].[job_id] = [sJOB].[job_id]
WHERE sJOB.name LIKE '%DB_ADMIN_DatabaseBackup%'



UPDATE [sJSTP]
SET  
	--[sJSTP].[command] = REPLACE([sJSTP].[command],@CurrentBkpLocation,@NewBkpLocation) --New Backup Location
	--[sJSTP].[command] = REPLACE([sJSTP].[command],@CurrentVerifySetting,@NewVerifySetting) --New Verify Setting
FROM
    [msdb].[dbo].[sysjobsteps] AS [sJSTP]
    INNER JOIN [msdb].[dbo].[sysjobs] AS [sJOB]
        ON [sJSTP].[job_id] = [sJOB].[job_id]
WHERE sJOB.name LIKE '%DB_ADMIN_DatabaseBackup%'


